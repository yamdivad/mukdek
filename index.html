<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Mukdek</title>
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg" id="dynamic-favicon">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #eaddcf; 
            color: #3e2723; 
            min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            touch-action: manipulation; overflow-y: auto; padding-bottom: 50px;
        }
        
        #identity-banner { 
            position: relative; width: 100%; padding: 15px; text-align: center; font-weight: bold; font-size: 1.2em; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; transition: all 0.3s; 
            border-bottom: 2px solid rgba(0,0,0,0.1); background: #d7ccc8; color: #3e2723;
            display: flex; justify-content: center; align-items: center;
        }
        
        h1 { font-size: 1.5em; margin: 10px 0; text-shadow: none; color: #5d4037; }
        
        #settings-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; cursor: pointer; z-index: 201; display: none; text-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #settings-btn:hover { transform: translateY(-50%) rotate(90deg); }
        #settings-menu { position: absolute; top: 100%; right: 10px; background: white; padding: 15px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; z-index: 200; border: 2px solid #5d4037; border-top: none; width: 200px; text-align: left; }
        #settings-menu button { background: #a1887f; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.9em; width: 100%; margin-bottom: 10px; }
        #btn-restart { background: #c62828 !important; }
        #btn-lightning { background: #ff9800 !important; color: #3e2723 !important; }

        #stats-btn { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; cursor: pointer; z-index: 201; text-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #stats-btn:hover { transform: translateY(-50%) scale(1.1); }
        #stats-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #eaddcf; padding: 25px; border-radius: 15px; max-width: 90%; width: 400px; text-align: center; border: 4px solid #5d4037; color: #3e2723; }
        .stats-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .stats-table td, .stats-table th { padding: 8px; border-bottom: 1px solid #a1887f; }
        .highlight-stat { font-weight: bold; color: #c62828; margin-top: 10px; }

        .status { display: flex; justify-content: center; flex-wrap: wrap; width: 95%; max-width: 600px; margin-bottom: 10px; background: rgba(255,255,255,0.4); border-radius: 10px; padding: 5px; border: 1px solid rgba(93, 64, 55, 0.2); gap: 5px; }
        .player-status { text-align: center; padding: 5px; border-radius: 8px; transition: all 0.3s; min-width: 60px; position: relative; border: 2px solid transparent; font-size: 0.8em; background-color: rgba(255,255,255,0.2); color: #5d4037; border: 1px dashed rgba(93, 64, 55, 0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-status.active { transform: scale(1.1); z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-style: solid; border-width: 2px; border-color: rgba(0,0,0,0.5); }
        .player-status.finished { opacity: 0.9; filter: grayscale(10%); }
        .player-status.empty-slot { text-decoration: line-through; opacity: 0.5; }
        .player-status strong { display: block; font-size: 1.2em; }
        
        #controls { margin-bottom: 10px; text-align: center; width: 100%; min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #dice { font-size: 4em; cursor: pointer; margin: 5px; color: #3e2723; width: 1.2em; height: 1.2em; line-height: 1.2em; text-align: center; display: flex; align-items: center; justify-content: center; }
        #dice.rolling { animation: roll 0.6s ease-in-out; }
        @keyframes roll { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-base { display: block; width: 80%; max-width: 300px; margin: 5px auto; padding: 15px; font-size: 1.3em; font-weight: bold; color: white; border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        #roll-btn { background: #a1887f; cursor: not-allowed; }
        #roll-btn.my-turn { background: #2e7d32; cursor: pointer; animation: pulse 1.5s infinite; }
        #roll-btn.game-over { background: #d32f2f; cursor: pointer; animation: none; }
        #ready-btn { background: #0277bd; margin-top: 10px; }
        #claim-host-btn { background: #7b1fa2; margin-top: 15px; font-size: 1em; padding: 10px; display: none; }
        
        #lobby-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(62, 39, 35, 0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .color-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0; }
        .color-btn { width: 60px; height: 60px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .color-btn:hover:not(:disabled) { transform: scale(1.1); border-color: white; }
        .color-btn.selected { transform: scale(1.2); border-color: white; box-shadow: 0 0 15px gold; z-index: 2; }
        .color-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(80%); }
        #name-input { width: 60%; padding: 10px; margin-bottom: 20px; text-align: center; font-size: 1.5em; border-radius: 10px; border: none; text-transform: uppercase; }
        #name-input:disabled { background: #ddd; color: #555; }
        #start-btn { background: #ff6f00; margin-top: 20px; opacity: 0.5; pointer-events: none; color: white; }
        #start-btn.ready { opacity: 1; pointer-events: all; }
        #join-btn { background: #2e7d32; }
        
        #ready-tracker { display: flex; justify-content: center; gap: 20px; margin: 15px 0; flex-wrap: wrap; max-width: 300px; }
        .tracker-slot { width: 40px; height: 40px; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: white; transition: all 0.3s; position: relative; margin: 5px; }
        .tracker-slot.joined { border-style: solid; opacity: 0.6; }
        .tracker-slot.ready { opacity: 1; box-shadow: 0 0 10px white; border-color: white; font-weight: bold; }
        .kick-btn { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; border: 1px solid white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .add-bot-btn { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: #2e7d32; color: white; border-radius: 5px; font-size: 10px; padding: 2px 5px; cursor: pointer; border: none; white-space: nowrap; }

        /* Dynamic aspect ratio based on JS updates */
        #board-container { 
            position: relative; 
            margin: 10px auto; 
            border: 8px solid #5d4037; 
            background: #eaddcf; 
            overflow: hidden; 
            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); 
            /* Width/Height set by JS, defaults for 4p */
            width: 95vmin;
            height: 95vmin;
        }
        #board { display: grid; gap: 0; width: 100%; height: 100%; background: transparent; padding: 1px; }
        .cell { background: transparent; position: relative; border-radius: 2px; }
        .track { background: #5d4037; border: 1px solid #4e342e; } 
        .shortcut { background: #009688; border: 2px solid #004d40; }
        .work, .home { background: #8d6e63; border: 1px solid #5d4037; opacity: 0.8; }
        
        .marble { 
            /* Dynamic sizing based on columns to keep them square */
            width: calc(100% / var(--grid-cols, 17) * 0.75);
            height: auto;
            aspect-ratio: 1 / 1;
            border-radius: 50%; 
            position: absolute; 
            z-index: 20; 
            box-shadow: 0 3px 5px rgba(0,0,0,0.4), inset 0 2px 3px rgba(255,255,255,0.6); 
            border: 2px solid rgba(255,255,255,0.8); 
            transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), left 0.5s cubic-bezier(0.25, 1, 0.5, 1), transform 0.3s; 
        }
        .marble[data-color="#ffffff"] { border: 2px solid #999; }
        .marble.movable { z-index: 100; cursor: pointer; filter: drop-shadow(0 0 5px gold); }
        .marble.movable::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; border-radius: 50%; border: 2px solid white; opacity: 0; animation: ringPulse 1.5s infinite; }
        @keyframes ringPulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }
        
        .ghost-marble { 
            width: calc(100% / var(--grid-cols, 17) * 0.75);
            height: auto;
            aspect-ratio: 1 / 1;
            border-radius: 50%; 
            position: absolute; 
            z-index: 15; 
            opacity: 0.5; 
            border: 2px dashed rgba(255,255,255,0.8); 
            pointer-events: none; 
            transition: all 0.2s; 
            animation: ghostPulse 1s infinite alternate; 
        }
        @keyframes ghostPulse { 0% { transform: scale(0.9); opacity: 0.4; } 100% { transform: scale(1.0); opacity: 0.7; } }
        .splat { 
            position: absolute; 
            width: calc(100% / var(--grid-cols, 17));
            height: auto;
            aspect-ratio: 1 / 1;
            border-radius: 50%; 
            z-index: 10; 
            pointer-events: none; 
            clip-path: polygon(20% 0%, 30% 20%, 50% 0%, 60% 25%, 90% 5%, 80% 40%, 100% 50%, 80% 60%, 95% 85%, 60% 75%, 50% 100%, 40% 75%, 10% 90%, 25% 60%, 0% 50%, 25% 40%); 
            animation: fadeSplat 2s forwards; 
        }
        @keyframes fadeSplat { 0% { opacity: 1; transform: scale(0); } 10% { transform: scale(1.5) rotate(10deg); } 100% { opacity: 0; transform: scale(1.5) rotate(20deg); } }

        #shortcut-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 80%; max-width: 300px; background: rgba(62, 39, 35, 0.95); border: 2px solid #d7ccc8; border-radius: 15px; padding: 20px; text-align: center; z-index: 500; box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: transform 0.3s; pointer-events: none; opacity: 0; color: white; }
        #shortcut-modal.active { transform: translate(-50%, -50%) scale(1); pointer-events: all; opacity: 1; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 5px; font-size: 1.1em; }
        .btn-yes { background: #2e7d32; color: white; }
        .btn-no { background: #c62828; color: white; }
        
        #target-pop { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            background: rgba(198, 40, 40, 0.95); color: white; 
            padding: 30px; border-radius: 50px; 
            font-size: 2em; font-weight: 900; 
            text-transform: uppercase; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            z-index: 1000; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.4); 
            pointer-events: none; transition: transform 0.4s; text-align: center; border: 4px solid white; 
        }
        #target-pop.active { transform: translate(-50%, -50%) scale(1); animation: shake 0.5s infinite; }
        #target-pop span { display: block; font-size: 0.5em; font-weight: normal; margin-top: 5px; opacity: 0.9; }
        
        #lightning-pop { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            background: rgba(255, 179, 0, 0.95); color: #3e2723; 
            padding: 30px; border-radius: 50px; 
            font-size: 2em; font-weight: 900; 
            text-transform: uppercase; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            z-index: 1001; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            pointer-events: none; transition: transform 0.4s; text-align: center; border: 4px solid white; 
        }
        #lightning-pop.active { transform: translate(-50%, -50%) scale(1); animation: shake 0.5s infinite; }
        
        @keyframes shake { 0%, 100% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-50%, -50%) rotate(-5deg); } 75% { transform: translate(-50%, -50%) rotate(5deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(46, 125, 50, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0); } }
    </style>
</head>
<body>
    
    <div id="lobby-overlay">
        <div class="lobby-content">
            <h1 style="color:white; font-size: 3em; margin-bottom: 0;">Mukdek</h1>
            <h2 style="color:#d7ccc8; font-size:1em; margin-bottom:10px;">Digital Edition</h2>
            
            <div id="lobby-ui-join" style="display:block;">
                <p style="color:#d7ccc8; margin-bottom:15px;">Waiting to join...</p>
                <button id="join-btn" class="btn-base" onclick="joinGame()">JOIN GAME</button>
            </div>

            <div id="lobby-ui-select" style="display:none;">
                <p style="color:white; margin-bottom: 5px;">You are <strong>Player <span id="lobby-pid">?</span></strong></p>
                
                <input type="text" id="name-input" placeholder="INITIALS" maxlength="3">
                
                <div id="mode-selector" style="margin: 15px 0; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
                    <p style="color:#d7ccc8; font-size: 0.9em; margin-bottom:5px;">SELECT BOARD TYPE:</p>
                    <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                        <button id="btn-mode-2p" class="btn-base" style="width:30%; min-width:80px; font-size:0.8em; margin:0; padding:10px;" onclick="selectMode('2p')">DUEL (2P)</button>
                        <button id="btn-mode-4p" class="btn-base" style="width:30%; min-width:80px; font-size:0.8em; margin:0; padding:10px;" onclick="selectMode('4p')">CLASSIC (4P)</button>
                        <button id="btn-mode-6p" class="btn-base" style="width:30%; min-width:80px; font-size:0.8em; margin:0; padding:10px;" onclick="selectMode('6p')">CHAOS (6P)</button>
                    </div>
                </div>

                <p style="color:#d7ccc8; font-size: 0.9em;">Choose your marble color:</p>
                <div class="color-grid" id="color-container"></div>
                
                <div id="ready-tracker">
                    <div id="tk-1" class="tracker-slot" title="Player 1"></div>
                    <div id="tk-2" class="tracker-slot" title="Player 2"></div>
                    <div id="tk-3" class="tracker-slot" title="Player 3"></div>
                    <div id="tk-4" class="tracker-slot" title="Player 4"></div>
                    <div id="tk-5" class="tracker-slot" title="Player 5"></div>
                    <div id="tk-6" class="tracker-slot" title="Player 6"></div>
                </div>

                <div id="lobby-msg" style="margin-bottom:10px; font-style:italic; color:#d7ccc8">Waiting for others...</div>
                
                <button id="ready-btn" class="btn-base" onclick="clickReady(true)" style="display:none;">I'M READY</button>
                <button id="start-btn" class="btn-base" onclick="requestStart()">START GAME</button>
                <button id="claim-host-btn" class="btn-base" onclick="claimHostManual()">CLAIM HOST üëë</button>
            </div>
        </div>
    </div>

    <div id="identity-banner">
        <div id="stats-btn" onclick="toggleStats()">üìä</div>
        <span id="identity-text">Spectating...</span>
        <div id="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</div>
        <div id="settings-menu">
            <button id="btn-lightning" onclick="toggleLightning()">ENABLE LIGHTNING</button>
            <button id="btn-restart" onclick="triggerReset()">RESTART GAME</button>
        </div>
    </div>

    <div id="stats-overlay" class="modal-overlay" onclick="toggleStats()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Game Stats</h2>
            <div id="stats-body">Waiting for data...</div>
            <button class="btn-base" onclick="toggleStats()" style="margin-top:20px; background:#5d4037; font-size:1em; padding:10px;">CLOSE</button>
        </div>
    </div>

    <div id="target-pop">TARGET!<br>TARGET!<br>TARGET!<span id="target-name">PLAYER X IS LEADING</span></div>
    <div id="lightning-pop">LIGHTNING MODE<br>ACTIVATED!</div>

    <h1>Mukdek</h1>
    
    <div class="status">
        <div class="player-status" id="p1"><strong>P1</strong><span class="home-count"><span id="h1">0</span>/5</span></div>
        <div class="player-status" id="p2"><strong>P2</strong><span class="home-count"><span id="h2">0</span>/5</span></div>
        <div class="player-status" id="p3"><strong>P3</strong><span class="home-count"><span id="h3">0</span>/5</span></div>
        <div class="player-status" id="p4"><strong>P4</strong><span class="home-count"><span id="h4">0</span>/5</span></div>
        <div class="player-status" id="p5"><strong>P5</strong><span class="home-count"><span id="h5">0</span>/5</span></div>
        <div class="player-status" id="p6"><strong>P6</strong><span class="home-count"><span id="h6">0</span>/5</span></div>
    </div>

    <div id="controls">
        <div id="message">Waiting for start...</div>
        <div id="dice">üé≤</div>
        <button id="roll-btn" class="btn-base" disabled>Wait for Game</button>
    </div>

    <div id="board-container">
        <div id="board"></div>
        <div id="shortcut-modal">
            <h2>Shortcut Available!</h2>
            <p style="color:white; margin-bottom:15px;">Do you want to take the center shortcut?</p>
            <button class="modal-btn btn-yes" onclick="confirmShortcut(true)">YES!</button>
            <button class="modal-btn btn-no" onclick="confirmShortcut(false)">NO</button>
        </div>
    </div>

    <audio id="turn-audio" src="assets/player-turn.mp3" preload="auto"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="gameLogic.js"></script>

    <script>
        const socket = io();
        let myPlayerId = null;
        let myColor = null;
        let currentGameState = null;
        let lastLeaderId = null; 
        
        let lastActivePlayer = null; 
        const turnAudio = document.getElementById('turn-audio');
        let turnSoundTimeout = null;
        let isLightningMode = false;
        let celebratedPlayers = new Set();
        let isFirstRender = true;
        let currentGameMode = '4p';

        const faviconLink = document.getElementById("dynamic-favicon");
        const originalFavicon = "favicon.svg";
        const goFavicon = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 rx=%22100%22 fill=%22%232ecc71%22/><text x=%2250%25%22 y=%2255%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-weight=%22900%22 font-size=%22300%22 fill=%22white%22>GO</text></svg>";

        document.body.addEventListener('click', () => {
            turnAudio.play().then(() => {
                turnAudio.pause();
                turnAudio.currentTime = 0;
            }).catch(() => {});
        }, { once: true });

        function getSessionId() {
            let sid = localStorage.getItem('mukdek_session');
            if (!sid) {
                sid = 'sess_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('mukdek_session', sid);
            }
            return sid;
        }
        const mySessionId = getSessionId();

        socket.on('connect', () => {
            console.log("Connected with session:", mySessionId);
            socket.emit('register', mySessionId);
        });

        const board = document.getElementById('board');
        const container = document.getElementById('board-container');
        const rollBtn = document.getElementById('roll-btn');
        const lobbyOverlay = document.getElementById('lobby-overlay');
        const lobbyJoinUI = document.getElementById('lobby-ui-join');
        const lobbySelectUI = document.getElementById('lobby-ui-select');
        const colorContainer = document.getElementById('color-container');
        const lobbyPidSpan = document.getElementById('lobby-pid');
        const startBtn = document.getElementById('start-btn');
        const readyBtn = document.getElementById('ready-btn');
        const claimHostBtn = document.getElementById('claim-host-btn');
        const bannerText = document.getElementById('identity-text');
        const banner = document.getElementById('identity-banner');
        const targetPop = document.getElementById('target-pop');
        const targetName = document.getElementById('target-name');
        const shortcutModal = document.getElementById('shortcut-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const btnLightning = document.getElementById('btn-lightning');
        const nameInput = document.getElementById('name-input');
        const lightningPop = document.getElementById('lightning-pop');
        const statsOverlay = document.getElementById('stats-overlay');
        const statsBody = document.getElementById('stats-body');

        let pendingShortcutMarbleId = null;
        let isFirstStatusLoad = true;

        nameInput.addEventListener('input', (e) => {
            socket.emit('setName', e.target.value);
        });

        function clickReady(status) {
            socket.emit('playerReady', status);
        }

        function claimHostManual() {
            socket.emit('claimHost');
        }
        
        function kickPlayer(pid) {
            if(confirm(`Are you sure you want to remove Player ${pid}?`)) {
                socket.emit('removeBot', pid - 1); 
                socket.emit('kickPlayer', pid); 
            }
        }
        
        function addBot(pid) {
            socket.emit('addBot', pid - 1);
        }

        function toggleSettings() {
            settingsMenu.style.display = (settingsMenu.style.display === 'block') ? 'none' : 'block';
        }

        function toggleStats() {
            statsOverlay.style.display = (statsOverlay.style.display === 'flex') ? 'none' : 'flex';
        }

        function triggerReset() {
            if (confirm("Are you sure you want to restart the game?")) {
                socket.emit('resetGame');
                toggleSettings(); 
            }
        }

        function toggleLightning() {
            socket.emit('toggleLightning');
            toggleSettings();
        }

        function updateFavicon(isTurn) {
            if (isTurn) {
                faviconLink.href = goFavicon;
            } else {
                faviconLink.href = originalFavicon;
            }
        }

        function selectMode(mode) {
            socket.emit('setGameMode', mode);
        }

        socket.on('gameModeUpdate', (mode) => {
            currentGameMode = mode;
            let btn2 = document.getElementById('btn-mode-2p');
            let btn4 = document.getElementById('btn-mode-4p');
            let btn6 = document.getElementById('btn-mode-6p');
            
            btn2.style.background = (mode === '2p') ? '#2e7d32' : '#a1887f';
            btn4.style.background = (mode === '4p') ? '#2e7d32' : '#a1887f';
            btn6.style.background = (mode === '6p') ? '#2e7d32' : '#a1887f';
            
            if (myPlayerId !== 1) {
                document.getElementById('mode-selector').style.pointerEvents = 'none';
                document.getElementById('mode-selector').style.opacity = '0.7';
            } else {
                document.getElementById('mode-selector').style.pointerEvents = 'all';
                document.getElementById('mode-selector').style.opacity = '1';
            }

            // Hide/Show slots based on mode
            // Always show 1 & 2
            document.getElementById('tk-3').style.display = (mode === '2p') ? 'none' : 'flex';
            document.getElementById('tk-4').style.display = (mode === '2p') ? 'none' : 'flex';
            document.getElementById('tk-5').style.display = (mode === '6p') ? 'flex' : 'none';
            document.getElementById('tk-6').style.display = (mode === '6p') ? 'flex' : 'none';
            
            // Status bars
            document.getElementById('p3').style.display = (mode === '2p') ? 'none' : 'block';
            document.getElementById('p4').style.display = (mode === '2p') ? 'none' : 'block';
            document.getElementById('p5').style.display = (mode === '6p') ? 'block' : 'none';
            document.getElementById('p6').style.display = (mode === '6p') ? 'block' : 'none';
        });

        socket.on('lightningStatus', (isOn) => {
            isLightningMode = isOn;

            if (isOn) {
                btnLightning.textContent = "DISABLE LIGHTNING";
                btnLightning.style.background = "#ffd600"; 
                
                lightningPop.innerHTML = "LIGHTNING MODE<br>ACTIVATED!";
                lightningPop.style.background = "rgba(255, 179, 0, 0.95)"; 
                lightningPop.style.color = "#3e2723";
                
                lightningPop.classList.remove('active');
                void lightningPop.offsetWidth; 
                lightningPop.classList.add('active');
                setTimeout(() => { lightningPop.classList.remove('active'); }, 2000);

                if (turnSoundTimeout) clearTimeout(turnSoundTimeout);

            } else {
                btnLightning.textContent = "ENABLE LIGHTNING";
                btnLightning.style.background = "#ff9800";

                if (!isFirstStatusLoad) {
                    lightningPop.innerHTML = "LIGHTNING MODE<br>DISABLED";
                    lightningPop.style.background = "rgba(66, 66, 66, 0.95)"; 
                    lightningPop.style.color = "#ffffff";
                    
                    lightningPop.classList.remove('active');
                    void lightningPop.offsetWidth; 
                    lightningPop.classList.add('active');
                    setTimeout(() => { lightningPop.classList.remove('active'); }, 2000);
                }
            }
            isFirstStatusLoad = false;
        });

        const colorPalette = [
            { name: "Red", hex: "#e74c3c" },
            { name: "Pink", hex: "#e91e63" },
            { name: "Dark Green", hex: "#1b5e20" },
            { name: "Light Green", hex: "#2ecc71" },
            { name: "Dark Blue", hex: "#1565c0" },
            { name: "Light Blue", hex: "#3498db" },
            { name: "White", hex: "#ffffff" },
            { name: "Black", hex: "#212121" },
            { name: "Yellow", hex: "#f1c40f" },
            { name: "Orange", hex: "#ff9800" },
            { name: "Purple", hex: "#9c27b0" }
        ];

        let gameColors = {}; 
        
        function initLobbyUI() {
            colorContainer.innerHTML = '';
            colorPalette.forEach((c, idx) => {
                let btn = document.createElement('button');
                btn.className = 'color-btn';
                btn.style.backgroundColor = c.hex;
                btn.title = c.name;
                btn.id = `col-btn-${idx}`;
                btn.onclick = () => selectColor(idx);
                colorContainer.appendChild(btn);
            });
        }
        
        function joinGame() { socket.emit('joinGame', mySessionId); }
        function selectColor(index) { socket.emit('selectColor', colorPalette[index].hex); }
        function requestStart() { socket.emit('requestStartGame'); }

        function getContrastColor(hex) {
            hex = hex.replace('#', '');
            let r = parseInt(hex.substr(0, 2), 16);
            let g = parseInt(hex.substr(2, 2), 16);
            let b = parseInt(hex.substr(4, 2), 16);
            let yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }

        socket.on('lobbyUpdate', (state) => {
            // Update mode buttons state
            if (myPlayerId === 1) {
                document.getElementById('mode-selector').style.pointerEvents = 'all';
                document.getElementById('mode-selector').style.opacity = '1';

                let btn2 = document.getElementById('btn-mode-2p');
                let btn4 = document.getElementById('btn-mode-4p');
                let btn6 = document.getElementById('btn-mode-6p');

                if (state.seatedCount > 2) {
                    btn2.disabled = true;
                    btn2.style.opacity = 0.5;
                } else {
                    btn2.disabled = false;
                    btn2.style.opacity = 1;
                }

                if (state.seatedCount > 4) {
                    btn4.disabled = true;
                    btn4.style.opacity = 0.5;
                } else {
                    btn4.disabled = false;
                    btn4.style.opacity = 1;
                }
            }

            for(let i=1; i<=6; i++) {
                let tk = document.getElementById(`tk-${i}`);
                if (!tk) continue;

                let pData = state.players[i];
                
                tk.className = 'tracker-slot';
                tk.style.backgroundColor = 'transparent';
                tk.innerHTML = '';
                while(tk.firstChild) tk.removeChild(tk.firstChild);

                if (!pData) {
                    if (myPlayerId === 1) {
                         let showAdd = false;
                         if (currentGameMode === '6p') showAdd = true;
                         else if (currentGameMode === '4p' && i <= 4) showAdd = true;
                         else if (currentGameMode === '2p' && i <= 2) showAdd = true;

                         if (showAdd) {
                             let botBtn = document.createElement('button');
                             botBtn.className = 'add-bot-btn';
                             botBtn.textContent = "+ BOT";
                             botBtn.onclick = () => addBot(i);
                             tk.appendChild(botBtn);
                         }
                    }
                } else {
                    tk.className = 'tracker-slot joined';
                    let c = pData.color || '#9e9e9e';
                    tk.style.backgroundColor = c;
                    
                    let statusSymbol = '';
                    if (pData.isBot) statusSymbol = 'ü§ñ';
                    else if (pData.ready) statusSymbol = (i === 1) ? 'üëë' : '‚úì';
                    
                    let symbolSpan = document.createElement('span');
                    symbolSpan.textContent = statusSymbol;
                    tk.appendChild(symbolSpan);

                    if (pData.ready) tk.classList.add('ready');
                    
                    if (myPlayerId === 1 && i !== 1) {
                        let kickBtn = document.createElement('div');
                        kickBtn.className = 'kick-btn';
                        kickBtn.textContent = 'X';
                        kickBtn.onclick = (e) => {
                            e.stopPropagation(); 
                            kickPlayer(i);
                        };
                        tk.appendChild(kickBtn);
                    }
                }
            }

            let mySlot = Object.entries(state.players).find(([k, v]) => v && v.session === mySessionId);
            
            if (mySlot) {
                myPlayerId = parseInt(mySlot[0]);
                let pData = mySlot[1];
                myColor = pData.color;
                let isMeReady = pData.ready;
                
                lobbyJoinUI.style.display = 'none';
                lobbySelectUI.style.display = 'block';
                lobbyPidSpan.textContent = myPlayerId;
                
                if (document.activeElement !== nameInput) {
                    nameInput.value = pData.name.replace(/^P\d$/, ''); 
                }

                if (isMeReady && myPlayerId !== 1) { 
                    nameInput.disabled = true;
                    readyBtn.style.display = 'block';
                    readyBtn.textContent = "CHANGE";
                    readyBtn.style.background = "#757575"; 
                    readyBtn.onclick = () => clickReady(false);
                    document.getElementById('lobby-msg').textContent = "Ready! Waiting for host...";
                } else {
                    nameInput.disabled = false;
                    if (myPlayerId !== 1) {
                        readyBtn.style.display = 'block';
                        readyBtn.textContent = "I'M READY";
                        readyBtn.style.background = "#0277bd"; 
                        readyBtn.onclick = () => clickReady(true);
                        document.getElementById('lobby-msg').textContent = "Pick color/initials, then click Ready.";
                    }
                }

                colorPalette.forEach((c, idx) => {
                    let btn = document.getElementById(`col-btn-${idx}`);
                    let takenBy = Object.values(state.players).find(p => p && p.color === c.hex);
                    
                    if (isMeReady && myPlayerId !== 1) {
                        btn.disabled = true;
                        if (myColor === c.hex) btn.classList.add('selected');
                        else btn.classList.remove('selected');
                        return; 
                    }

                    if (myColor === c.hex) {
                        btn.classList.add('selected');
                        btn.disabled = false;
                    } else if (takenBy) {
                        btn.classList.remove('selected');
                        btn.disabled = true;
                    } else {
                        btn.classList.remove('selected');
                        btn.disabled = false;
                    }
                });
                
                let pName = pData.name || `P${myPlayerId}`;
                updateIdentity(myPlayerId, myColor || '#9e9e9e', pName);

            } else {
                lobbyJoinUI.style.display = 'block';
                lobbySelectUI.style.display = 'none';
                
                let limit = 4;
                if (currentGameMode === '6p') limit = 6;
                else if (currentGameMode === '2p') limit = 2;

                if (state.seatedCount >= limit) {
                    document.getElementById('join-btn').disabled = true;
                    document.getElementById('join-btn').textContent = "FULL";
                } else {
                    document.getElementById('join-btn').disabled = false;
                    document.getElementById('join-btn').textContent = "JOIN GAME";
                }
            }

            if (socket.id === state.hostId) {
                let seated = Object.values(state.players).filter(p => p !== null);
                let allReady = seated.length >= 2 && seated.every(p => p.color !== null);
                
                readyBtn.style.display = 'none'; 
                startBtn.style.display = 'block';
                claimHostBtn.style.display = 'none'; 
                
                let validMode = true;
                if (currentGameMode === '2p' && seated.length !== 2) validMode = false;
                if (currentGameMode === '6p' && seated.length < 2) validMode = false; 

                if (allReady && validMode) {
                    startBtn.classList.add('ready');
                    startBtn.disabled = false;
                    document.getElementById('lobby-msg').textContent = "You are the Host. Start when everyone is ready.";
                } else {
                    startBtn.classList.remove('ready');
                    startBtn.disabled = true;
                    if (currentGameMode === '2p' && seated.length !== 2) {
                        document.getElementById('lobby-msg').textContent = "Duel Mode requires exactly 2 players.";
                    } else {
                        document.getElementById('lobby-msg').textContent = "Waiting for players...";
                    }
                }
            } else {
                startBtn.style.display = 'none';
                if (myPlayerId === 1) {
                    claimHostBtn.style.display = 'block';
                } else {
                    claimHostBtn.style.display = 'none';
                }
            }
        });
        
        socket.on('kicked', () => {
            alert("You have been removed from the lobby by the Host.");
            location.reload();
        });

        function getPosStyle(col, row) {
            let mapData = gameLogic.MAPS[currentGameMode || '4p'];
            let cols = mapData ? mapData.gridCols : 17;
            let rows = mapData ? mapData.gridRows : 17;
            
            // Percentage of grid cell relative to container
            let cellPctX = 100/cols;
            let cellPctY = 100/rows;
            
            let centerX = (col * cellPctX) + (cellPctX/2);
            let centerY = (row * cellPctY) + (cellPctY/2);
            
            return {
                left: `calc(${centerX}% - 2.25%)`,
                top: `calc(${centerY}% - 2.25%)`
            };
        }

        function showGhost(mid) {
            let movesPair = currentGameState.possibleMoves.find(pm => pm[0] === mid);
            if (!movesPair) return;
            
            let moves = movesPair[1];
            moves.forEach(move => {
                let ghost = document.createElement('div');
                ghost.className = `ghost-marble ghost-${mid}`;
                let posStyle = getPosStyle(move.dest.col, move.dest.row);
                ghost.style.left = posStyle.left;
                ghost.style.top = posStyle.top;
                
                let pColor = gameColors[myPlayerId] || '#999';
                ghost.style.backgroundColor = pColor;
                
                container.appendChild(ghost);
            });
        }

        function hideGhost(mid) {
            let ghosts = document.querySelectorAll(`.ghost-${mid}`);
            ghosts.forEach(g => g.remove());
        }

        function clearAllGhosts() {
            let ghosts = document.querySelectorAll('.ghost-marble');
            ghosts.forEach(g => g.remove());
        }

        function initBoard(mode) {
            board.innerHTML = '';
            let mapData = gameLogic.MAPS[mode || '4p'];
            
            let cols = mapData.gridCols;
            let rows = mapData.gridRows;
            
            // Pass grid size to CSS
            container.style.setProperty('--grid-cols', cols);
            container.style.setProperty('--grid-rows', rows);

            // Smart Container Sizing to prevent stretching
            // We want the largest rectangle of ratio (cols/rows) that fits in 95vmin x 95vmin
            let targetRatio = cols / rows;
            if (cols >= rows) {
                // Wide board: Width = 95vmin, Height = 95vmin / ratio
                container.style.width = '95vmin';
                container.style.height = `calc(95vmin / ${targetRatio})`;
            } else {
                // Tall board: Height = 95vmin, Width = 95vmin * ratio
                container.style.height = '95vmin';
                container.style.width = `calc(95vmin * ${targetRatio})`;
            }

            // Update grid template
            board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            board.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

            const trackSet = new Set(mapData.trackStr);
            let shortcuts = new Set();
            if (mapData.shortcutStr && mode !== '6p') shortcuts.add(mapData.shortcutStr);
            mapData.players.forEach(p => {
                if (p.targetShortcutStr) shortcuts.add(p.targetShortcutStr);
            });

            let workSets = [], homeSets = [];
            mapData.players.forEach(p => {
                workSets[p.id] = new Set(p.workStr);
                homeSets[p.id] = new Set(p.homeStr);
            });

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';
                    let key = gameLogic.colMap[c] + (r + 1);
                    
                    if (trackSet.has(key)) cell.classList.add('track');
                    if (shortcuts.has(key)) cell.classList.add('shortcut'); 
                    
                    mapData.players.forEach(p => {
                        if (workSets[p.id].has(key)) {
                            cell.classList.add('work');
                        }
                        else if (homeSets[p.id].has(key)) cell.classList.add('home');
                    });
                    
                    board.appendChild(cell);
                }
            }
        }

        function updateIdentity(pid, colorHex, pName) {
            if(!pid) return;
            bannerText.textContent = `YOU ARE ${pName || 'PLAYER ' + pid}`;
            banner.style.backgroundColor = colorHex;
            banner.style.color = getContrastColor(colorHex);

            let rotation = 0;
            // Only rotate in 4P mode
            if (currentGameMode === '4p') {
                switch(pid) {
                    case 1: rotation = 180; break;
                    case 2: rotation = 90; break;
                    case 3: rotation = 0; break;
                    case 4: rotation = 270; break;
                }
            }
            container.style.transform = `rotate(${rotation}deg)`;
            shortcutModal.style.transform = `translate(-50%, -50%) rotate(${-rotation}deg) scale(0)`;
        }

        function checkForLeader(marbles) {
            let maxP = (currentGameMode === '2p') ? 2 : (currentGameMode === '6p' ? 6 : 4);
            let counts = new Array(maxP).fill(0);
            
            marbles.forEach(m => {
                if (gameLogic.isHomePos(currentGameState.mode, m.player, m.pos)) {
                    if (m.player <= maxP) counts[m.player - 1]++;
                }
            });

            let max = Math.max(...counts);
            if (max === 0) return; 

            let leaders = [];
            counts.forEach((c, i) => { if(c === max) leaders.push(i + 1); });

            if (leaders.length === 1) {
                let newLeader = leaders[0];
                if (newLeader !== lastLeaderId) {
                    lastLeaderId = newLeader;
                    triggerTargetPopup(newLeader);
                }
            } else {
                lastLeaderId = null; 
            }
        }

        function triggerTargetPopup(pid) {
            triggerPopup(pid, "IS LEADING!");
        }

        function triggerPopup(pid, suffix, isWinner = false) {
            let pColor = gameColors[pid] || '#999';
            let pName = (currentGameState.playerNames && currentGameState.playerNames[pid]) || `PLAYER ${pid}`;
            
            if (isWinner) {
                targetPop.innerHTML = `<span style="font-size:1.5em; display:block; margin-top:10px;">${pName}</span>WINS!`;
            } else {
                targetPop.innerHTML = `TARGET!<br>TARGET!<br>TARGET!<span id="target-name">${pName} ${suffix}</span>`;
            }
            
            targetPop.style.backgroundColor = pColor;
            targetPop.style.color = getContrastColor(pColor);
            
            targetPop.classList.remove('active');
            void targetPop.offsetWidth; 
            targetPop.classList.add('active');
            
            setTimeout(() => { targetPop.classList.remove('active'); }, 3000); 
        }

        function renderStats(stats, names) {
            if (!stats) return;
            let html = '<table class="stats-table"><tr><th>Player</th><th>Taken Others</th><th>Been Taken</th></tr>';
            
            let maxKills = -1; let killer = null;
            let maxDeaths = -1; let victim = null;

            let maxP = (currentGameMode === '2p') ? 2 : (currentGameMode === '6p' ? 6 : 4);

            for(let i=1; i<=maxP; i++) {
                if(!names[i]) continue; 
                let kills = stats.murders[i] || 0;
                let deaths = stats.deaths[i] || 0;
                
                let suffix = '';
                if (currentGameState && currentGameState.finishedPlayers) {
                    let finishIdx = currentGameState.finishedPlayers.indexOf(i);
                    if (finishIdx !== -1) {
                        if (finishIdx === 0) suffix = ' ü•á';
                        else if (finishIdx === 1) suffix = ' ü•à';
                        else if (finishIdx === 2) suffix = ' ü•â';
                    }
                }

                html += `<tr><td>${names[i]}${suffix}</td><td>${kills}</td><td>${deaths}</td></tr>`;
                
                if (kills > maxKills) { maxKills = kills; killer = names[i]; }
                if (deaths > maxDeaths) { maxDeaths = deaths; victim = names[i]; }
            }
            html += '</table>';
            
            if (maxKills > 0) html += `<div class="highlight-stat">Most Ruthless: ${killer} (${maxKills})</div>`;
            if (maxDeaths > 0) html += `<div class="highlight-stat">Most Targeted: ${victim} (${maxDeaths})</div>`;
            
            statsBody.innerHTML = html;
        }

        socket.on('murder', (data) => {
            let splat = document.createElement('div');
            splat.className = 'splat';
            let victimColor = gameColors[data.victimId] || '#b71c1c';
            splat.style.background = `radial-gradient(circle, ${victimColor} 40%, transparent 70%)`;

            // Recalc pos based on dynamic grid
            let mapData = gameLogic.MAPS[currentGameMode || '4p'];
            let cols = mapData ? mapData.gridCols : 17;
            let rows = mapData ? mapData.gridRows : 17;
            
            let cellPctX = 100/cols;
            let cellPctY = 100/rows;
            
            let centerX = (data.pos.col * cellPctX) + (cellPctX/2);
            let centerY = (data.pos.row * cellPctY) + (cellPctY/2);
            splat.style.left = `calc(${centerX}% - 2.75%)`; 
            splat.style.top = `calc(${centerY}% - 2.75%)`;
            container.appendChild(splat);
            setTimeout(() => { splat.remove(); }, 2000);
        });

        function renderState(state) {
            clearAllGhosts();

            currentGameState = state;
            gameColors = state.playerColors || {};
            
            renderStats(state.stats, state.playerNames);

            state.finishedPlayers.forEach((pid, index) => {
                if (gameColors[pid]) { 
                    if (!celebratedPlayers.has(pid)) {
                        celebratedPlayers.add(pid);
                        
                        if (!isFirstRender) {
                            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                            if (index === 0) triggerPopup(pid, "", true);
                        }
                    }
                }
            });
            isFirstRender = false;

            if (state.phase === 'play') {
                if (state.activePlayer === myPlayerId) {
                    if (turnSoundTimeout) clearTimeout(turnSoundTimeout);
                    
                    let duration = (lastActivePlayer !== myPlayerId) ? 5000 : 15000;
                    
                    if (!isLightningMode) {
                        turnSoundTimeout = setTimeout(() => {
                            turnAudio.currentTime = 0;
                            turnAudio.play().catch(e => console.log("Audio blocked"));
                        }, duration); 
                    }
                    updateFavicon(true);
                } else {
                    if (turnSoundTimeout) clearTimeout(turnSoundTimeout);
                    updateFavicon(false);
                }
                lastActivePlayer = state.activePlayer;
            }

            if (state.activePlayer !== myPlayerId) {
                if (turnSoundTimeout) {
                    clearTimeout(turnSoundTimeout);
                    turnSoundTimeout = null;
                }
                updateFavicon(false); 
            }

            const sBtn = document.getElementById('settings-btn');
            const sMenu = document.getElementById('settings-menu');
            
            if (myPlayerId === 1 && state.phase !== 'gameover') {
                if(sBtn) sBtn.style.display = 'block';
            } else {
                if(sBtn) sBtn.style.display = 'none';
                if(sMenu) sMenu.style.display = 'none';
            }
            
            document.getElementById('message').textContent = state.message;
            const diceChars = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            document.getElementById('dice').textContent = state.currentRoll > 0 ? diceChars[state.currentRoll - 1] : 'üé≤';

            let maxP = (currentGameMode === '2p') ? 2 : (currentGameMode === '6p' ? 6 : 4);
            let needed = (currentGameMode === '6p') ? 4 : 5;

            for(let i=1; i<=maxP; i++) {
                let el = document.getElementById(`p${i}`);
                let pColor = gameColors[i];
                let pName = (state.playerNames && state.playerNames[i]) || `P${i}`;
                
                let isRealPlayer = !!pColor;

                if (!isRealPlayer) {
                    el.classList.add('empty-slot');
                    el.querySelector('strong').textContent = pName;
                    el.style.backgroundColor = 'rgba(255,255,255,0.2)';
                    el.style.color = '#5d4037';
                    el.style.border = '1px dashed rgba(93, 64, 55, 0.3)';
                    el.style.opacity = '0.7';
                } else {
                    el.classList.remove('empty-slot');
                    
                    let realFinishers = state.finishedPlayers.filter(pid => gameColors[pid]);
                    let rankIdx = realFinishers.indexOf(i);
                    
                    let suffix = '';
                    if (rankIdx === 0) suffix = ' ü•á';
                    else if (rankIdx === 1) suffix = ' ü•à';
                    else if (rankIdx === 2) suffix = ' ü•â';
                    
                    el.querySelector('strong').textContent = pName + suffix;

                    if (pColor) {
                        el.style.backgroundColor = pColor;
                        el.style.color = getContrastColor(pColor);
                        el.style.border = '2px solid rgba(0,0,0,0.2)';
                        el.style.opacity = '1';
                    }

                    if (state.finishedPlayers.includes(i)) {
                        el.classList.add('finished');
                    } else {
                        el.classList.remove('finished');
                    }
                }

                if(i === state.activePlayer) el.classList.add('active');
                else el.classList.remove('active');
                
                let inHome = state.marbles.filter(m => m.player === i && gameLogic.isHomePos(currentGameState.mode, i, m.pos)).length;
                document.getElementById(`h${i}`).textContent = inHome;
                el.querySelector('.home-count').innerHTML = `<span id="h${i}">${inHome}</span>/${needed}`;
            }

            checkForLeader(state.marbles);

            const isMyTurn = (state.activePlayer === myPlayerId);
            const isGameOver = state.phase === 'gameover';
            
            if (isGameOver) {
                rollBtn.textContent = "GAME OVER / NEW GAME";
                rollBtn.disabled = false;
                rollBtn.className = 'btn-base game-over';
                rollBtn.onclick = () => {
                    if(confirm("Start a new game with the same players?")) {
                        socket.emit('resetGame');
                    }
                };
                document.getElementById('dice').classList.remove('rolling');
            } else if (isMyTurn) {
                if (state.currentRoll === 0 || state.phase === 'init') {
                    rollBtn.textContent = state.phase === 'init' ? "ROLL FOR ORDER" : "ROLL DICE";
                    rollBtn.disabled = false;
                    rollBtn.className = 'btn-base my-turn';
                    rollBtn.onclick = () => { 
                        document.getElementById('dice').classList.add('rolling');
                        socket.emit('rollDice'); 
                    };
                } else {
                    rollBtn.textContent = "MOVE A MARBLE";
                    rollBtn.disabled = true; 
                    rollBtn.className = 'btn-base';
                    document.getElementById('dice').classList.remove('rolling');
                }
            } else {
                let activeName = (state.playerNames && state.playerNames[state.activePlayer]) || `P${state.activePlayer}`;
                rollBtn.textContent = `WAITING FOR ${activeName}`;
                rollBtn.disabled = true;
                rollBtn.className = 'btn-base';
            }

            let posGroups = {};
            state.marbles.forEach(m => {
                let key = m.pos.col + "_" + m.pos.row;
                if (!posGroups[key]) posGroups[key] = [];
                posGroups[key].push(m);
            });
            let existingMs = document.querySelectorAll('.marble');
            existingMs.forEach(em => {
                let id = parseInt(em.id.split('-')[1]);
                if(!state.marbles.find(m => m.id === id)) em.remove();
            });
            state.marbles.forEach(m => {
                let el = document.getElementById(`m-${m.id}`);
                if (!el) {
                    el = document.createElement('div');
                    el.id = `m-${m.id}`;
                    el.className = `marble`;
                    container.appendChild(el);
                }
                let mColor = gameColors[m.player] || '#999';
                el.style.background = `radial-gradient(circle at 30% 30%, white -20%, ${mColor} 30%, black 140%)`;
                
                let isMovable = state.movableMarbles.includes(m.id) && m.player === myPlayerId;
                if (isMovable) {
                    el.classList.add('movable');
                    el.onclick = () => handleMarbleClick(m.id);
                    
                    el.onmouseenter = () => showGhost(m.id);
                    el.onmouseleave = () => hideGhost(m.id);
                } else {
                    el.classList.remove('movable');
                    el.onclick = null;
                    el.onmouseenter = null;
                    el.onmouseleave = null;
                }

                let group = posGroups[m.pos.col + "_" + m.pos.row];
                let indexInGroup = group.findIndex(gm => gm.id === m.id);
                
                let mapData = gameLogic.MAPS[currentGameMode || '4p'];
                let cols = mapData ? mapData.gridCols : 17;
                let rows = mapData ? mapData.gridRows : 17;
                
                let cellPctX = 100/cols;
                let cellPctY = 100/rows;
                
                let centerX = (m.pos.col * cellPctX) + (cellPctX/2);
                let centerY = (m.pos.row * cellPctY) + (cellPctY/2);
                let offX = 0, offY = 0;
                if (group.length > 1) {
                     offX = (indexInGroup % 2 === 0 ? 1 : -1) * 0.8 * (Math.floor(indexInGroup/2) + 1);
                     offY = (indexInGroup % 2 !== 0 ? 1 : -1) * 0.8 * (Math.floor(indexInGroup/2) + 1);
                }
                el.style.left = `calc(${centerX + offX}% - 2.25%)`; 
                el.style.top = `calc(${centerY + offY}% - 2.25%)`;
            });
        }

        function handleMarbleClick(mid) {
            clearAllGhosts();

            let movesPair = currentGameState.possibleMoves.find(pm => pm[0] === mid);
            if (!movesPair) return;
            let moves = movesPair[1];

            if (moves.some(m => m.type === 'shortcut') && moves.length > 1) {
                pendingShortcutMarbleId = mid;
                let rotation = 0;
                if (currentGameMode === '4p') {
                    if (myPlayerId === 1) rotation = 180;
                    else if (myPlayerId === 2) rotation = 90;
                    else if (myPlayerId === 4) rotation = 270;
                }
                shortcutModal.style.transform = `translate(-50%, -50%) rotate(${-rotation}deg) scale(1)`;
                shortcutModal.classList.add('active');
            } else {
                let type = moves.length === 1 ? moves[0].type : 'normal';
                socket.emit('makeMove', { marbleId: mid, moveType: type });
            }
        }

        function confirmShortcut(takeIt) {
            shortcutModal.classList.remove('active');
            setTimeout(() => {
                let rotation = 0;
                if (currentGameMode === '4p') {
                     if (myPlayerId === 1) rotation = 180;
                     else if (myPlayerId === 2) rotation = 90;
                     else if (myPlayerId === 4) rotation = 270;
                }
                shortcutModal.style.transform = `translate(-50%, -50%) rotate(${-rotation}deg) scale(0)`;
            }, 300);

            if (pendingShortcutMarbleId !== null) {
                let type = takeIt ? 'shortcut' : 'normal';
                socket.emit('makeMove', { marbleId: pendingShortcutMarbleId, moveType: type });
                pendingShortcutMarbleId = null;
            }
        }

        socket.on('gameStart', (mode) => { 
            currentGameMode = mode;
            lobbyOverlay.style.display = 'none'; 
            celebratedPlayers.clear();
            initBoard(mode); 
        });
        socket.on('gameReset', () => {
             lobbyOverlay.style.display = 'flex';
             board.innerHTML = '';
             initBoard(currentGameMode); 
             settingsMenu.style.display = 'none';
             celebratedPlayers.clear();
        });
        socket.on('gameState', renderState);

        initLobbyUI();
        initBoard('4p'); // Default render 4p map in background
    </script>
</body>
</html>